<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CloudHound - AWS Security Graph Analytics</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  <style>
    :root {
      /* Core palette */
      --bg-primary: #0a0d12;
      --bg-secondary: #0f1419;
      --bg-tertiary: #151c24;
      --bg-elevated: #1a232e;
      --bg-hover: #1f2937;

      /* Borders */
      --border-subtle: #1f2937;
      --border-default: #2d3748;
      --border-strong: #4a5568;

      /* Text */
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-tertiary: #64748b;
      --text-muted: #475569;

      /* Accent colors */
      --accent-primary: #3b82f6;
      --accent-primary-hover: #2563eb;
      --accent-secondary: #8b5cf6;
      --accent-success: #10b981;
      --accent-warning: #f59e0b;
      --accent-danger: #ef4444;
      --accent-info: #06b6d4;

      /* Severity */
      --severity-critical: #dc2626;
      --severity-high: #ef4444;
      --severity-medium: #f59e0b;
      --severity-low: #10b981;
      --severity-info: #3b82f6;

      /* Node colors */
      --node-account: #6366f1;
      --node-role: #8b5cf6;
      --node-user: #10b981;
      --node-s3: #f59e0b;
      --node-ec2: #ec4899;
      --node-lambda: #f97316;
      --node-kms: #ef4444;
      --node-sg: #06b6d4;
      --node-default: #3b82f6;

      /* Sizing */
      --header-height: 56px;
      --sidebar-width: 280px;
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
      --shadow-glow: 0 0 20px rgb(59 130 246 / 0.15);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.5;
    }

    /* Header */
    header {
      height: var(--header-height);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      position: relative;
      z-index: 100;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }

    .brand-text {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: -0.5px;
    }

    .brand-text span {
      color: var(--accent-primary);
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 500;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
    }

    .status-badge.ok {
      background: rgba(16, 185, 129, 0.1);
      border-color: rgba(16, 185, 129, 0.3);
      color: var(--accent-success);
    }

    .status-badge.error {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--accent-danger);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .theme-toggle {
      padding: 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .theme-toggle:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-default);
    }

    /* Layout */
    .layout {
      display: grid;
      grid-template-columns: var(--sidebar-width) 1fr;
      height: calc(100vh - var(--header-height));
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .sidebar-section:last-child {
      border-bottom: none;
      flex: 1;
      overflow-y: auto;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
    }

    /* Form elements */
    .form-group {
      margin-bottom: 12px;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 13px;
      transition: all 0.15s ease;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-textarea {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      min-height: 100px;
      resize: vertical;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      border: none;
    }

    .btn-primary {
      background: var(--accent-primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-primary-hover);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-default);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-block {
      width: 100%;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    /* Main content */
    .main {
      background: var(--bg-primary);
      overflow-y: auto;
      padding: 20px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      background: var(--bg-secondary);
      padding: 4px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
    }

    .tab {
      padding: 10px 20px;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .tab.active {
      background: var(--accent-primary);
      color: white;
    }

    /* Cards */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .card-body {
      padding: 20px;
    }

    .card-body.no-padding {
      padding: 0;
    }

    /* Graph container */
    #cy {
      width: 100%;
      height: 500px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
    }

    .graph-resizer {
      height: 8px;
      margin-top: 8px;
      cursor: ns-resize;
      background: var(--bg-hover);
      border-radius: var(--radius-sm);
      transition: background 0.15s ease;
    }

    .graph-resizer:hover {
      background: var(--accent-primary);
    }

    /* Legend */
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: var(--radius-sm);
    }

    /* Tables */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-subtle);
    }

    th {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      background: var(--bg-tertiary);
    }

    tr:hover td {
      background: var(--bg-hover);
    }

    td {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Severity badges */
    .severity {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .severity.critical {
      background: rgba(220, 38, 38, 0.15);
      color: var(--severity-critical);
    }

    .severity.high {
      background: rgba(239, 68, 68, 0.15);
      color: var(--severity-high);
    }

    .severity.medium {
      background: rgba(245, 158, 11, 0.15);
      color: var(--severity-medium);
    }

    .severity.low {
      background: rgba(16, 185, 129, 0.15);
      color: var(--severity-low);
    }

    .severity.info {
      background: rgba(59, 130, 246, 0.15);
      color: var(--severity-info);
    }

    /* Code */
    code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      padding: 2px 6px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      color: var(--accent-info);
    }

    pre {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 16px;
      overflow-x: auto;
      color: var(--text-secondary);
    }

    /* Details panel */
    .detail-panel {
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      padding: 16px;
    }

    .detail-empty {
      text-align: center;
      color: var(--text-tertiary);
      padding: 32px;
    }

    .detail-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Environment stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .stat-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
      transition: all 0.15s ease;
    }

    .stat-card:hover {
      border-color: var(--accent-primary);
      box-shadow: var(--shadow-glow);
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
    }

    /* Environment list */
    .env-list {
      list-style: none;
    }

    .env-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s ease;
    }

    .env-item:hover {
      background: var(--bg-hover);
    }

    .env-item:last-child {
      border-bottom: none;
    }

    .env-type {
      font-weight: 600;
      color: var(--accent-primary);
      min-width: 120px;
    }

    .env-id {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--text-secondary);
      word-break: break-all;
    }

    /* Data management */
    .upload-zone {
      border: 2px dashed var(--border-default);
      border-radius: var(--radius-lg);
      padding: 32px;
      text-align: center;
      background: var(--bg-tertiary);
      transition: all 0.15s ease;
    }

    .upload-zone:hover {
      border-color: var(--accent-primary);
      background: rgba(59, 130, 246, 0.05);
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      color: var(--text-tertiary);
    }

    .upload-text {
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .upload-files {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
      text-align: left;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    /* Message */
    .message {
      padding: 12px 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      font-size: 13px;
    }

    .message.error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--accent-danger);
    }

    .message.success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--accent-success);
    }

    /* Cypher status */
    .cypher-status {
      font-size: 12px;
      margin-top: 8px;
      color: var(--text-tertiary);
    }

    .cypher-status.success {
      color: var(--accent-success);
    }

    .cypher-status.error {
      color: var(--accent-danger);
    }

    /* Arrow in table */
    .arrow {
      color: var(--text-tertiary);
      margin: 0 4px;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-tertiary);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-default);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-strong);
    }

    /* Light theme */
    body.light {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --bg-elevated: #ffffff;
      --bg-hover: #e2e8f0;
      --border-subtle: #e2e8f0;
      --border-default: #cbd5e1;
      --border-strong: #94a3b8;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-tertiary: #64748b;
      --text-muted: #94a3b8;
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    /* Fullscreen graph */
    .graph-fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 1000 !important;
      margin: 0 !important;
      border-radius: 0 !important;
    }

    .graph-fullscreen #cy {
      height: calc(100vh - 120px) !important;
      border-radius: 0 !important;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="brand-logo">CH</div>
      <div class="brand-text">Cloud<span>Hound</span></div>
    </div>
    <div class="header-status">
      <div class="status-badge" id="apiStatus">
        <span class="status-dot"></span>
        <span>API: Checking...</span>
      </div>
      <div class="status-badge" id="neo4jStatus">
        <span class="status-dot"></span>
        <span>Neo4j: Unknown</span>
      </div>
      <button class="theme-toggle" id="themeToggle" title="Toggle theme">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <line x1="12" y1="1" x2="12" y2="3"></line>
          <line x1="12" y1="21" x2="12" y2="23"></line>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
          <line x1="1" y1="12" x2="3" y2="12"></line>
          <line x1="21" y1="12" x2="23" y2="12"></line>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
      </button>
    </div>
  </header>

  <div class="layout">
    <nav class="sidebar">
      <div class="sidebar-section">
        <div class="section-header">
          <span class="section-title">Filters</span>
        </div>
        <div class="form-group">
          <label class="form-label">Severity</label>
          <select class="form-select" id="severityFilter">
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Search</label>
          <input type="search" class="form-input" id="searchInput" placeholder="Search by ARN or ID...">
        </div>
        <div class="form-group">
          <label class="form-label">Node Type</label>
          <input type="search" class="form-input" id="typeFilter" placeholder="Role, User, S3Bucket...">
        </div>
        <button class="btn btn-primary btn-block" id="filterBtn">Apply Filters</button>
      </div>

      <div class="sidebar-section">
        <div class="section-header">
          <span class="section-title">Cypher Query</span>
        </div>
        <div class="form-group">
          <textarea class="form-textarea" id="cypherInput" placeholder="MATCH (n) RETURN n LIMIT 25"></textarea>
        </div>
        <button class="btn btn-secondary btn-block" id="runCypherBtn">Run Query</button>
        <div class="cypher-status" id="cypherStatus"></div>
      </div>
    </nav>

    <main class="main">
      <div class="tabs">
        <button class="tab active" data-tab="graph">Graph</button>
        <button class="tab" data-tab="env">Environment</button>
        <button class="tab" data-tab="data">Data</button>
        <button class="tab" data-tab="settings">Settings</button>
      </div>

      <div id="msg" class="message error hidden"></div>

      <!-- Graph Tab -->
      <div id="tab-graph">
        <div class="card" id="graphCard">
          <div class="card-header">
            <span class="card-title">Attack Path Graph</span>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary btn-sm" id="resetLayoutBtn">Reset Layout</button>
              <button class="btn btn-secondary btn-sm" id="fullscreenBtn">Fullscreen</button>
            </div>
          </div>
          <div class="card-body">
            <div class="legend">
              <div class="legend-item"><span class="legend-swatch" style="background: var(--node-account)"></span>Account</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--node-role)"></span>Role</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--node-user)"></span>User</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--node-s3)"></span>S3</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--node-ec2)"></span>EC2</div>
              <div class="legend-item"><span class="legend-swatch" style="background: var(--severity-high)"></span>Attack Path</div>
            </div>
            <div id="cy"></div>
            <div class="graph-resizer" id="graphResizer"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Attack Paths</span>
            <span style="font-size: 12px; color: var(--text-tertiary);" id="attackCount">0 findings</span>
          </div>
          <div class="card-body no-padding">
            <div class="table-wrapper">
              <table id="attacksTable">
                <thead>
                  <tr>
                    <th>Rule</th>
                    <th>Description</th>
                    <th>Severity</th>
                    <th>Source / Target</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Selection Details</span>
          </div>
          <div class="card-body">
            <div class="detail-panel" id="detailContent">
              <div class="detail-empty">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 16v-4M12 8h.01"></path>
                </svg>
                <p>Click a node or edge in the graph to view details</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Cypher Results</span>
          </div>
          <div class="card-body">
            <pre id="cypherOutput">// Query results will appear here</pre>
          </div>
        </div>
      </div>

      <!-- Environment Tab -->
      <div id="tab-env" class="hidden">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Resource Overview</span>
          </div>
          <div class="card-body">
            <div class="stats-grid" id="statsGrid">
              <div class="empty-state">
                <p>Load data to see resource statistics</p>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Environment Objects</span>
            <span style="font-size: 12px; color: var(--text-tertiary);" id="objectCount">0 objects</span>
          </div>
          <div class="card-body no-padding">
            <ul class="env-list" id="envList">
              <li class="empty-state">
                <p>No environment data loaded</p>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Data Tab -->
      <div id="tab-data" class="hidden">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Data Management</span>
          </div>
          <div class="card-body">
            <div class="upload-zone">
              <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
              <p class="upload-text">Upload CloudHound data files to visualize</p>
              <div class="upload-files">
                <div class="form-group">
                  <label class="form-label">Nodes File (.jsonl)</label>
                  <input type="file" class="form-input" id="nodesFile" accept=".jsonl">
                </div>
                <div class="form-group">
                  <label class="form-label">Edges File (.jsonl)</label>
                  <input type="file" class="form-input" id="edgesFile" accept=".jsonl">
                </div>
              </div>
              <div class="action-buttons" style="justify-content: center;">
                <button class="btn btn-primary" id="loadBtn">Load Files</button>
              </div>
            </div>

            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
              <h4 style="font-size: 13px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">API Actions</h4>
              <div class="action-buttons">
                <button class="btn btn-secondary" id="fetchApiBtn">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"></path>
                  </svg>
                  Fetch from API
                </button>
                <button class="btn btn-secondary" id="downloadReportBtn">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                  Download Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Tab -->
      <div id="tab-settings" class="hidden">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Connection Settings</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">API Base URL</label>
              <input type="text" class="form-input" id="apiBase" value="http://127.0.0.1:5000">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Graph Settings</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Layout Algorithm</label>
              <select class="form-select" id="layoutSelect">
                <option value="cose">COSE (Force-directed)</option>
                <option value="breadthfirst">Breadthfirst (Hierarchical)</option>
                <option value="concentric">Concentric (Circular)</option>
                <option value="grid">Grid</option>
                <option value="circle">Circle</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Node Label Position</label>
              <select class="form-select" id="labelPos">
                <option value="center">Center</option>
                <option value="bottom">Below</option>
                <option value="top">Above</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">Appearance</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Theme</label>
              <select class="form-select" id="theme">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // State
    let cy = null;
    let nodes = [];
    let edges = [];
    let isFullscreen = false;

    // Utilities
    function parseJsonl(text) {
      return text.trim().split(/\r?\n/).filter(Boolean).map(line => JSON.parse(line));
    }

    async function readFile(input) {
      if (!input.files || !input.files.length) return [];
      return parseJsonl(await input.files[0].text());
    }

    function nodeLabel(n) {
      const p = n.properties || {};
      return p.name || p.role_name || p.user_name || n.id?.split('/').pop() || n.type;
    }

    function nodeColor(type) {
      const t = (type || '').toLowerCase();
      if (t.includes('account')) return getComputedStyle(document.documentElement).getPropertyValue('--node-account').trim();
      if (t.includes('role')) return getComputedStyle(document.documentElement).getPropertyValue('--node-role').trim();
      if (t.includes('user')) return getComputedStyle(document.documentElement).getPropertyValue('--node-user').trim();
      if (t.includes('s3')) return getComputedStyle(document.documentElement).getPropertyValue('--node-s3').trim();
      if (t.includes('ec2') || t.includes('instance')) return getComputedStyle(document.documentElement).getPropertyValue('--node-ec2').trim();
      if (t.includes('lambda')) return getComputedStyle(document.documentElement).getPropertyValue('--node-lambda').trim();
      if (t.includes('kms')) return getComputedStyle(document.documentElement).getPropertyValue('--node-kms').trim();
      if (t.includes('security')) return getComputedStyle(document.documentElement).getPropertyValue('--node-sg').trim();
      return getComputedStyle(document.documentElement).getPropertyValue('--node-default').trim();
    }

    function severityColor(sev) {
      const s = (sev || '').toLowerCase();
      if (s === 'critical') return getComputedStyle(document.documentElement).getPropertyValue('--severity-critical').trim();
      if (s === 'high') return getComputedStyle(document.documentElement).getPropertyValue('--severity-high').trim();
      if (s === 'medium') return getComputedStyle(document.documentElement).getPropertyValue('--severity-medium').trim();
      if (s === 'low') return getComputedStyle(document.documentElement).getPropertyValue('--severity-low').trim();
      return getComputedStyle(document.documentElement).getPropertyValue('--severity-info').trim();
    }

    // Build graph
    function buildGraph(nodeData, edgeData) {
      const severityFilter = document.getElementById('severityFilter').value.toLowerCase();
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const typeFilter = document.getElementById('typeFilter').value.toLowerCase();
      const layout = document.getElementById('layoutSelect').value;

      // Filter edges
      const filteredEdges = edgeData.filter(e => {
        if (e.type !== 'AttackPath') return true;
        if (severityFilter && (e.properties?.severity || '').toLowerCase() !== severityFilter) return false;
        return true;
      });

      // Build node map with filtering
      const nodeMap = {};
      nodeData.forEach(n => {
        if (searchTerm && !n.id.toLowerCase().includes(searchTerm)) return;
        if (typeFilter && !n.type.toLowerCase().includes(typeFilter)) return;
        nodeMap[n.id] = n;
      });

      // Ensure edge endpoints exist
      filteredEdges.forEach(e => {
        if (!nodeMap[e.src]) nodeMap[e.src] = { id: e.src, type: 'Unknown', properties: {} };
        if (!nodeMap[e.dst]) nodeMap[e.dst] = { id: e.dst, type: 'Unknown', properties: {} };
      });

      // Build Cytoscape elements
      const elements = [];
      Object.values(nodeMap).forEach(n => {
        elements.push({
          data: { id: n.id, label: nodeLabel(n), type: n.type, properties: n.properties }
        });
      });

      filteredEdges.forEach((e, i) => {
        elements.push({
          data: {
            id: `${e.src}->${e.dst}:${e.type}:${i}`,
            source: e.src,
            target: e.dst,
            label: e.type === 'AttackPath' ? (e.properties?.rule || e.type) : e.type,
            severity: e.properties?.severity || '',
            edgeType: e.type,
            properties: e.properties
          },
          classes: e.type === 'AttackPath' ? 'attack' : ''
        });
      });

      // Initialize or update Cytoscape
      if (!cy) {
        cy = cytoscape({
          container: document.getElementById('cy'),
          elements: elements,
          style: getCyStyle(),
          layout: { name: layout, animate: false },
          // Finer zoom control settings
          wheelSensitivity: 0.15,
          minZoom: 0.1,
          maxZoom: 5,
          zoomingEnabled: true,
          userZoomingEnabled: true,
          panningEnabled: true,
          userPanningEnabled: true
        });
        setupCyEvents();
      } else {
        cy.elements().remove();
        cy.add(elements);
        cy.layout({ name: layout, animate: false }).run();
      }
    }

    function getCyStyle() {
      const isDark = !document.body.classList.contains('light');
      const textColor = isDark ? '#f1f5f9' : '#0f172a';
      const edgeColor = isDark ? '#4a5568' : '#cbd5e1';
      // Edge label colors - lighter in dark mode, darker in light mode for better contrast
      const edgeLabelColor = isDark ? '#e2e8f0' : '#1e293b';

      return [
        {
          selector: 'node',
          style: {
            'background-color': ele => nodeColor(ele.data('type')),
            'label': 'data(label)',
            'font-size': '10px',
            'font-weight': '500',
            'color': textColor,
            'text-valign': document.getElementById('labelPos')?.value || 'center',
            'text-halign': 'center',
            'text-margin-y': document.getElementById('labelPos')?.value === 'bottom' ? 8 : (document.getElementById('labelPos')?.value === 'top' ? -8 : 0),
            'width': 32,
            'height': 32,
            'border-width': 2,
            'border-color': isDark ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)',
            'text-background-color': isDark ? '#0f1419' : '#ffffff',
            'text-background-opacity': 0.9,
            'text-background-padding': '3px',
            'text-background-shape': 'roundrectangle',
            'font-family': 'Inter, sans-serif'
          }
        },
        {
          selector: 'edge',
          style: {
            'width': 1.5,
            'line-color': edgeColor,
            'target-arrow-color': edgeColor,
            'target-arrow-shape': 'triangle',
            'arrow-scale': 0.8,
            'curve-style': 'bezier',
            'label': 'data(label)',
            'font-size': '9px',
            'font-weight': '500',
            'color': edgeLabelColor,
            'text-rotation': 'autorotate',
            'text-background-color': isDark ? 'rgba(15, 20, 25, 0.85)' : 'rgba(255, 255, 255, 0.85)',
            'text-background-opacity': 1,
            'text-background-padding': '2px',
            'text-background-shape': 'roundrectangle',
            'font-family': 'Inter, sans-serif'
          }
        },
        {
          selector: '.attack',
          style: {
            'line-color': ele => severityColor(ele.data('severity')),
            'target-arrow-color': ele => severityColor(ele.data('severity')),
            'width': 2.5,
            'line-style': 'solid'
          }
        },
        {
          selector: ':selected',
          style: {
            'border-width': 3,
            'border-color': '#3b82f6'
          }
        }
      ];
    }

    function setupCyEvents() {
      cy.on('tap', 'node, edge', evt => {
        const data = evt.target.data();
        const isNode = evt.target.isNode();
        const html = `
          <div style="font-size: 12px;">
            <div style="font-weight: 600; margin-bottom: 8px; color: var(--accent-primary);">
              ${isNode ? 'Node' : 'Edge'}: ${data.type || data.edgeType || 'Unknown'}
            </div>
            <div style="margin-bottom: 8px;">
              <code style="word-break: break-all;">${data.id || ''}</code>
            </div>
            <pre style="margin: 0; max-height: 300px; overflow: auto;">${JSON.stringify(data.properties || data, null, 2)}</pre>
          </div>
        `;
        document.getElementById('detailContent').innerHTML = html;
      });

      cy.on('tap', evt => {
        if (evt.target === cy) {
          document.getElementById('detailContent').innerHTML = `
            <div class="detail-empty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px; opacity: 0.5;">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4M12 8h.01"></path>
              </svg>
              <p>Click a node or edge in the graph to view details</p>
            </div>
          `;
        }
      });
    }

    function renderAttacks(edgeData) {
      const attacks = edgeData.filter(e => e.type === 'AttackPath');
      const severityFilter = document.getElementById('severityFilter').value.toLowerCase();
      const filtered = attacks.filter(e => {
        if (severityFilter && (e.properties?.severity || '').toLowerCase() !== severityFilter) return false;
        return true;
      });

      document.getElementById('attackCount').textContent = `${filtered.length} finding${filtered.length !== 1 ? 's' : ''}`;

      const tbody = document.querySelector('#attacksTable tbody');
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="empty-state" style="padding: 32px;"><p>No attack paths found</p></td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map(e => {
        const sev = (e.properties?.severity || 'info').toLowerCase();
        return `
          <tr>
            <td><code>${e.properties?.rule || 'unknown'}</code></td>
            <td>${e.properties?.description || ''}</td>
            <td><span class="severity ${sev}">${sev}</span></td>
            <td>
              <code style="font-size: 11px;">${truncate(e.src, 30)}</code>
              <span class="arrow">â†’</span>
              <code style="font-size: 11px;">${truncate(e.dst, 30)}</code>
            </td>
          </tr>
        `;
      }).join('');
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.slice(0, len) + '...' : str;
    }

    function renderStats(nodeData) {
      const counts = {};
      nodeData.forEach(n => {
        counts[n.type] = (counts[n.type] || 0) + 1;
      });

      const grid = document.getElementById('statsGrid');
      const keys = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);

      if (!keys.length) {
        grid.innerHTML = '<div class="empty-state"><p>Load data to see resource statistics</p></div>';
        return;
      }

      grid.innerHTML = keys.map(k => `
        <div class="stat-card">
          <div class="stat-value">${counts[k]}</div>
          <div class="stat-label">${k}</div>
        </div>
      `).join('');
    }

    function renderEnvList(nodeData) {
      document.getElementById('objectCount').textContent = `${nodeData.length} object${nodeData.length !== 1 ? 's' : ''}`;

      const list = document.getElementById('envList');
      if (!nodeData.length) {
        list.innerHTML = '<li class="empty-state"><p>No environment data loaded</p></li>';
        return;
      }

      list.innerHTML = nodeData.slice(0, 100).map(n => `
        <li class="env-item">
          <span class="env-type">${n.type}</span>
          <span class="env-id">${n.id}</span>
        </li>
      `).join('');
    }

    function showMessage(text, type = 'error') {
      const msg = document.getElementById('msg');
      msg.textContent = text;
      msg.className = `message ${type}`;
      msg.classList.remove('hidden');
      setTimeout(() => msg.classList.add('hidden'), 5000);
    }

    function updateStatus(apiOk, neoOk) {
      const api = document.getElementById('apiStatus');
      const neo = document.getElementById('neo4jStatus');

      api.className = `status-badge ${apiOk ? 'ok' : 'error'}`;
      api.innerHTML = `<span class="status-dot"></span><span>API: ${apiOk ? 'Connected' : 'Error'}</span>`;

      neo.className = `status-badge ${neoOk ? 'ok' : ''}`;
      neo.innerHTML = `<span class="status-dot"></span><span>Neo4j: ${neoOk ? 'Connected' : 'Unknown'}</span>`;
    }

    // Event Listeners
    document.getElementById('loadBtn').addEventListener('click', async () => {
      try {
        nodes = await readFile(document.getElementById('nodesFile'));
        edges = await readFile(document.getElementById('edgesFile'));

        if (!nodes.length && !edges.length) {
          showMessage('No data found in uploaded files');
          return;
        }

        buildGraph(nodes, edges);
        renderAttacks(edges);
        renderStats(nodes);
        renderEnvList(nodes);

        // Switch to graph tab
        switchTab('graph');
      } catch (err) {
        showMessage(`Error loading files: ${err.message}`);
      }
    });

    document.getElementById('filterBtn').addEventListener('click', () => {
      if (!nodes.length && !edges.length) return;
      buildGraph(nodes, edges);
      renderAttacks(edges);
    });

    document.getElementById('fetchApiBtn').addEventListener('click', async () => {
      const base = document.getElementById('apiBase').value;
      try {
        const resp = await fetch(`${base}/graph?limit=1000`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        nodes = data.nodes || [];
        edges = data.edges || [];

        buildGraph(nodes, edges);
        renderAttacks(edges);
        renderStats(nodes);
        renderEnvList(nodes);
        updateStatus(true, true);
        switchTab('graph');
      } catch (err) {
        showMessage(`API fetch failed: ${err.message}`);
        updateStatus(false, false);
      }
    });

    document.getElementById('runCypherBtn').addEventListener('click', async () => {
      const base = document.getElementById('apiBase').value;
      const cypher = document.getElementById('cypherInput').value;
      const status = document.getElementById('cypherStatus');
      const output = document.getElementById('cypherOutput');

      status.textContent = 'Running...';
      status.className = 'cypher-status';

      try {
        const resp = await fetch(`${base}/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cypher, limit: 200 })
        });
        const data = await resp.json();

        if (!resp.ok) {
          status.textContent = `Error: ${data.error || resp.status}`;
          status.className = 'cypher-status error';
          return;
        }

        status.textContent = `Success - ${(data.results || []).length} results`;
        status.className = 'cypher-status success';
        output.textContent = JSON.stringify(data.results || [], null, 2);
      } catch (err) {
        status.textContent = `Error: ${err.message}`;
        status.className = 'cypher-status error';
      }
    });

    document.getElementById('downloadReportBtn').addEventListener('click', () => {
      const attacks = edges.filter(e => e.type === 'AttackPath');
      const counts = {};
      nodes.forEach(n => { counts[n.type] = (counts[n.type] || 0) + 1; });

      const report = {
        generated_at: new Date().toISOString(),
        summary: {
          total_nodes: nodes.length,
          total_edges: edges.length,
          attack_paths: attacks.length,
          resource_counts: counts
        },
        attack_paths: attacks,
        sample_nodes: nodes.slice(0, 100)
      };

      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `cloudhound-report-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

      ['graph', 'env', 'data', 'settings'].forEach(t => {
        const el = document.getElementById(`tab-${t}`);
        if (el) el.classList.toggle('hidden', t !== tabName);
      });

      if (tabName === 'graph' && cy) cy.resize();
    }

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => switchTab(tab.dataset.tab));
    });

    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
      document.body.classList.toggle('light');
      document.getElementById('theme').value = document.body.classList.contains('light') ? 'light' : 'dark';
      if (cy) {
        cy.style(getCyStyle());
      }
    });

    document.getElementById('theme').addEventListener('change', (e) => {
      document.body.classList.toggle('light', e.target.value === 'light');
      if (cy) {
        cy.style(getCyStyle());
      }
    });

    // Fullscreen
    document.getElementById('fullscreenBtn').addEventListener('click', () => {
      const card = document.getElementById('graphCard');
      isFullscreen = !isFullscreen;
      card.classList.toggle('graph-fullscreen', isFullscreen);
      document.getElementById('fullscreenBtn').textContent = isFullscreen ? 'Exit Fullscreen' : 'Fullscreen';
      if (cy) cy.resize();
    });

    // Reset layout
    document.getElementById('resetLayoutBtn').addEventListener('click', () => {
      if (cy) {
        cy.layout({ name: document.getElementById('layoutSelect').value, animate: true }).run();
      }
    });

    // Layout change
    document.getElementById('layoutSelect').addEventListener('change', () => {
      if (cy) {
        cy.layout({ name: document.getElementById('layoutSelect').value, animate: true }).run();
      }
    });

    // Label position change
    document.getElementById('labelPos').addEventListener('change', () => {
      if (cy) {
        cy.style(getCyStyle());
      }
    });

    // Graph resizer
    const resizer = document.getElementById('graphResizer');
    let isResizing = false;

    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      e.preventDefault();
    });

    window.addEventListener('mousemove', (e) => {
      if (!isResizing) return;
      const cyEl = document.getElementById('cy');
      const rect = cyEl.getBoundingClientRect();
      const newH = Math.min(900, Math.max(300, e.clientY - rect.top));
      cyEl.style.height = `${newH}px`;
      if (cy) cy.resize();
    });

    window.addEventListener('mouseup', () => { isResizing = false; });

    // Escape key for fullscreen
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isFullscreen) {
        document.getElementById('fullscreenBtn').click();
      }
    });

    // Initial status check
    (async function checkStatus() {
      const base = document.getElementById('apiBase').value;
      try {
        const resp = await fetch(`${base}/health`);
        const data = await resp.json();
        updateStatus(data.status === 'ok', data.status === 'ok');
      } catch {
        updateStatus(false, false);
      }
    })();
  </script>
</body>
</html>
